# 데이터베이스 테스트
<hr>

### 데이터베이스 테스트를 위한 전제조건

<br>

#### 1. 데이터베이스를 형상 관리 시스템에 유지
- 데이터베이스 스키마를 일반 코드로 취급하여 Git과 같은 형상 관리 시스템에 저장하는 것이다.
- 개발DB와 운영DB를 분리한 뒤 개발 DB의 스키마에 변경을 가한 뒤 이를 운영 배포 시점에 운영 DB의 스키마에 비교하여 적용하는 것은 안티패턴이다.
    - 이유 1. 변경 내역 부재이다. DB 스키마를 과거의 특정 시점으로 되돌릴 수 없다.(이는 운영 환경에서 특정 버그를 재현할 때 중요할 수 있다.)
    - 이유 2. 복수의 원천 정보
- 형상 관리 시스템을 사용하면 데이터베이스 변경을 추적할 수 있다. 또한 형상 관리 외부에서는 해당 DB의 구조를 변경해서는 안된다.

<br>

#### 2. 참조 데이터도 데이터베이스 스키마이다.
- 참조 데이터와 일반 데이터를 구별하는 방법은 애플리케이션이 데이터를 수정할 수 있으면 일반 데이터이고, 그렇지 않으면 수정 데이터이다.

<br>

#### 3. 모든 개발자를 위한 별도의 데이터베이스 인스턴스
- 실제 DB를 사용하여 테스트 하는 것은 어렵다. 또한 하나의 개발 DB를 다른 개발자와 공유하여 테스트하면 경쟁 조건등 고려할 범위가 많아진다. 따라서 개발자마다 별도의 DB를 구축하여 테스트해야한다.

<br>

#### 4. 상태 기반과 마이그레이션 기반의 데이터베이스 배포

💡상태 기반 방식
- 개발 DB의 스키마와 운영 DB의 스키마를 비교 툴을 사용하여 유지관리하는 것이다. (형상 관리 시스템)
- 상태를 형상 관리에 저장함으로써 상태를 명시하고 비교 도구가 마이그레이션을 암묵적으로 제어할 수 있게 한다.

💡마이그레이션 기반 방식
- 데이터베이스를 어떤 버전에서 다른 버전으로 전환하는 명시적인 마이그레이션을 의미한다.
- 마이그레이션을 명시적으로 하지만 상태를 암묵적으로 둔다. 데이터베이스 상태를 직접 볼 수 없으며 마이그레이션으로 조합해야 한다.

<br>

### 데이터베이스 트랜젹션 관리
<hr>

- 작업 단위 패턴
  - 객체의 CUD가 발생하면 데이터베이스에 기록해야 한다. 
  - 작업 단위는 이러한 변경 내용을 추적하는 객체이다. 
  - 데이터베이스에 영향을 미칠 수 있는 작업을 시작하면 작업단위를 만들고 이러한 변경 내용을 추적해야 하며, 객체를 생성, 수정, 삭제할 때마다 이를 작업 단위에 알려야 한다.

<br>

### 테스트 데이터 생명 주기
<hr>

- 테스트는 데이터베이스 상태에 따라 달라지면 안된다. 테스트는 데이터베이스 상태를 원하는 조건으로 만들어야 한다.

#### 테스트 실행간 데이터 정리하기

1. 각 테스트 전에 데이터베이스 백업 및 복원하기
2. 테스트 종료 시점에 데이터 정리하기
3. 데이터베이스 트랜잭션에 각 테스트를 래핑하고 커밋하지 않기
4. 테스트 시작 시점에 데이터 정리하기

<br>

#### 인메모리 데이터베이스 피하기
- 인메모리 데이터베이스는 일반 데이터베이스와 기능적으로 일관성이 없기 때문에 사용하지 않는 것이 좋다.
- 이는 운영 환경과 테스트 환경이 일치하지 않는 문제이며, 일반 데이터베이스와 인메모리 데이터베이스의 차이로 인해 테스트에서 거짓 양성 또는 거짓 음성이 발생하기 쉽다.

<br>

### 테스트 구절에서 코드 재사용하기
<hr>

- 아무리 짧은 테스트일지라도 서로 의존해서는 안된다.
- 또한 테스트 시나리오의 전체 문맥을 유지해야하며, 진행 상황을 이해하려고 테스트 클래스의 다른 부분을 검사해서는 안된다.
- 통합 테스트를 짧게 하기에 가장 좋은 방법은 비지니스와 관련 없는 기술적인 부분을 비공개 메서드나 헬퍼 클래스로 추출하는 것이다.
- 이러한 부분을 얼마든지 재사용할 수 있다.

<br>

### 공유 해보면 좋을 의견들
<hr>

1. 데이터베이스 형상관리 시스템이 무엇인가?
2. CDP에서 참조 키 제약을 어떻게 가져가면 좋을지 논의하고 이를 프로젝트에 같이 적용하면 좋을거 같다.
    - 생명 주기가 같다면 참조를 설정하는 것이 좋고, 그렇지 않다면 참조를 걸지 않고 PK만 가지고 있어도 괜찮고, 특정 행위에 대한 로그를 남길 때 생명 주기가 같겠지만 참조를 걸어야할까? 걸지 않아도 될까 등
