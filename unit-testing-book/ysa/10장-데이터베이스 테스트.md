# 10장-데이터베이스 테스트

- 상태기반 데이터베이스 배포 방식 / 마이그레이션 기반 데이터 베이스 방식

## 10.1 데이터베이스 테스트를 위한 전제 조건

- 형상 관리 시스템에 데이터베이스 유지
- 모든 개발자를 위한 별도의 데이터베이스 인스턴스 사용
- 데이터베이스 배포에 마이그레이션 기반 방식 적용

### 10.1.1 데이터베이스 형상 관리 시스템에 유지

1. 데이터 베이스 스키마를 일반 코드로 취급
2. 데이터베이스 스키마는 git과 같은 형상 관리 시스템에 저장
    - 변경을 추적할 수 있다.
    - 형상관리 외부에서는 데이터베이스 구조를 수정하면 안된다.

### 10.1.2 참조 데이터도 데이터베이스 스키마다

- 데이터 베이스 스키마 : 테이블, 뷰, 인덱스, 저장 프로시저 등등
- SQL 스크립트 형태로 표현
- 참조 데이터는 애플리케이션이 제대로 작동하도록 미리 채워야하는 데이터이다.
- 애플리케이션이 데이터를 수정할 수 있으면 일반데이터, 수정 할 수 없으면 참조 데이터
- 참조 데이터는 Insert문 형태로 형상 관리 시스템에 저장

### 10.1.3 모든 개발자를 위한 별도의 데이터베이스 인스턴스

- 공유 데이터베이스를 사용하지 말고 별도 데이터베이스 인스턴스를 사용

### 10.1.4 상태 기반 데이터베이스 배포와 마이그레이션 기반 데이터베이스 배포

1. 상태 기반 방식
    - 배포 중에 비교도구가 스크립트를 생성해서 운영 데이터베이스를 모델 데이터베이스와 비교해 최신상태로 유지
    - 물리적인 모델 데이터 베이스  ≠ 원천데이터
    - 비교도구가 불필요한 테이블을 삭제하고 새 테이블을 생성하고 컬럼명을 바꾸는 등 모델 데이터베이스와 동기화하는데 필요한 모든 작업을 수행
2. 마이그레이션 기반 방식
    - 데이터베이스를 다른 버전으로 전환
3. 상태 기반 방식보다 마이그레이션 기반 방식을 선호하라
- 상태 기반 : 상태를 형상관리에 저장함으로써, 상태를 명시하고 비교 도구가 마이그레이션을 암묵적으로 제어
- 마이그레이션 기반 : 마이그레이션을 명시적으로 하지만 상태를 암묵적으로 둔다.
- 데이터 베이스 스키마는 객관적이지만 데이터는 상황에 따라 달라진다.
    - name → firstname / lastname
- 마이그레이션 기반이 데이터 모션에 장점을 갖는다.

> - 마이그레이션을 통해 데이터베이스 스키마에 모든 수정사항을 적용하라
- 형상관리에 마이그레이션이 커밋된 후에는 수정을 금지하라
- 마이그레이션이 잘못된경우 이새 마이그레이션을 생성하라
- 데이터가 손실될 수 있는 경우에만 이 규칙을 예외로 하라
> 

## 10.2 데이터 베이스 트랜잭션 관리

### 10.2.1 제품 코드에서 데이터 베이스 트랜잭션 관리하기

- 원자적 업데이트 : 모두 수행하거나 전혀 수행하지 않는 것
- 원자적 업데이트 세트의 각 업데이트는 전체적으로 완료되거나 아무런 영향도 미치지 않아야한다.
- 데이터베이스 트랜잭션에서 데이터 베이스 연결 분리하기
    - repository, 트랜잭션 분리
    - commit() : 비즈니스 연산이 모두 성공하고 수정을 저장할 준비가 된 경우 호출
    - dispose() : 트랜잭션을 종료, commit이 호출되지않으면 롤백
- 작업 단위로 트랜잭션 업그레이드하기
    - 업데이트 지연

 

### 10.2.2 통합 테스트에서 데이터베이스 트랜잭션 관리하기

- 테스트 실행 구절 간에 데이터베이스 트랜잭션이나 작업 단위를 재사용X
- 적어도 3개의 트랜잭션 또는 작업단위를 사용 (준비, 실행, 검증 구절당 하나씩)

## 10.3 테스트 데이터 생명주기

- 통합테스트 순차적으로 실행
- 테스트 실행 간에 남은 데이터를 제거

### 10.3.1 병렬 테스트 실행과 순차적 테스트 실행

- 병렬실행은 상당한 노력 필요
- 순차적으로 통합테스트를 실행하는것이 더 실용적

### 10.3.2 테스트 실행 간 데이터 정리

- 테스트 전에 데이터베이스 백업 복원하기
- 테스트 종료 시점에 데터 정리하기
- 데이터베이스 트랜잭션에 각 테스트를 래핑하지않고 커밋하지 않기
- 테스트 시작 시점에 데이터 정리하기
    - 참조 데이터는 제거하지 말아야한다.

### 10.3.3 인메모리 데이터베이스 피하기

- 일반 데이터베이스와 다른 환경
- 거짓 양성 또는 거짓 음성 발생 가능
- 운영환경과 같은 데이터 베이스 관리 시스템을 이용하기

## 10.4 테스트 구절에서 코드 재사용하기

### 10.4.1 준비 구절에서 코드 재사용하기

- 비공개 팩토리 메서드 사용
- 테스트 코드와 동일한 클래스에 배치

### 10.4.2 실행 구절에서 코드 재사용 하기

- 데코레이터 메서드 사용

### 10.4.3 검증 구절에서 코드 재사용하기

- 플루언트 인터페이스

개발자 장비에 인스턴스 호스팅