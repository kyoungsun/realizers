# 08장 통합 테스트를 하는 이유

## 8.1 통합 테스트는 무엇인가?

### 8.1.1 통합 테스트의 역할

- 단위 테스트가 아닌 모든 테스트는 통합 테스트이다.
- 통합 테스트ㅌ는 대부분 시스템이 프로세스 외부 의존성과 어떻게 작동하는지 검증
- 컨트롤러 사분면에 속하는 코드를 검증

### 8.1.2 다시 보는 테스트 피라미드

- 통합 테스트가 많아지면, 유지비가 많이 든다.
- 유지비가 많이 드는 이유
    - 프로세스 외부 의존성 운영이 필요
    - 관련된 협력자가 많아서 테스트가 비대
- 통합테스트는 시나리오의 성공적인 실행과 단위 테스트가 다루지 못하는 기타 예외 사항을 다룬다.
- 테스트 피라미드는 절대적이지 않다. 프로젝트 복잡도에 따라, 통합테스와 단위테스트 비율이 동일 할 수 있다.
- 통합 테스트는 다른 서브 쓰템과 통합해 어떻게 작동하는것인지 확인한다.

### 8.1.3 통합 테스트와 빠른 실패

- 통합 테스트에서 프로세스 외부 의존성과의 상호작용을 모두 확인하려면 가장 긴 주요 흐름을 선택하라???
- 빠른 실패 원칙

```
빠른 실패 원칙은 예기치 않은 오류가 발생하자마자 현재 연산을 중단하는 것을 의미
1. 피드백 루프 단축 : 버그를 빨리 발견할 수록 더 쉽게 해결할 수 있다. 운영 환경에서 발견하는 버그보다
 개발중에 발견하는 버그가 수정비용이 적다.
2. 지속성 상태 보호 : 손상된 상태가 데이터베이스로 침투하면 고치기가 어렵다. 빨리 실패하면 막을 수 있다.

보통 예외를 던져서 현재 연산을 중지한다.
```

## 8.2 어떤 프로세스 외부 의존성을 직접 테스트해야하는가

### 8.2.1 프로세스 외부 의존성의 두가지 유형

```
1. **관리 의존성(전체를 제어할 수 있는 프로세스 외부 의존성)** : 데이터 베이스 → 구현 세부사항
2. **비관리 의존성(전체를 제어할 수 없는 프로세스 외부 의존성)** : SMTP서버, 메시지 버스  → 식별할 수 있는 동작
```

- 관리 의존성은 실제 인스턴스를 사용하고, 비관리 의존성은 목으로 대체하라.
- 관리 의존성과 통신하는 것은 애플리케이션뿐이므로 하위 호환성을 유지할 필요가 없다.
- 관리 의존성과의 통신은 구현 세부사항, 비관리 의존성과의 통신은 식별할 수 있는 동작이다.

### 8.2.2 관리 의존성이면서 비관리 의존성인 프로세스 외부 의존성 다루기

- 다른 애플리케이션이 접근할 수 있는 데이터베이스
- 일부 테이블이 다른 애플리케이션에서 접근할 수 있는 경우
- 없는 것이 베스트
- 비관리 의존성을 가진 부분은 목으로 대체하고, 나머지 데이터베이스는 관리 의존성으로 처리
- 상호작용이 아닌, 최종 상태를 검증

### 8.2.3 통합 테스트에서 실제 데이터베이스를 사용할 수 없으면 어떻게 할까?

- 도메인 모델의 단위테스트에만 집중하라.
- 통합 테스트를 작성하지 말 것

## 8.3 통합 테스트: 예제

- 사용자 이메일 변경
    - 데이터베이스에서 사용자와 회사를 검색하고
    - 의사 결정을 도메인 모델에서 위임한 다음
    - 결과를 데이터베이스에 다시 저장하고
    - 필요한 경우 메시지 버스에 메시지를 싣는다.

### 8.3.1 어떤 시나리오를 테스트 할까?

- 가장 긴 주요 흐름과 단위 테스트로는 수행할 수 없는 모든 예외사항을 다루도록 한다.
- 가장 긴 주요 흐름 : 모든 프로세스 외부 의존성을 거치는것
- 이 예제에서 가장 긴 주요 흐름은? 기업 이메일 → 일반 이메일로 변경
    - DB에서 사용자와 회사 모두 update
    - 메시지 버스로 메시지를 보낸다.

### 8.3.2 데이터베이스와 메시지 버스 분류하기

- 외부 의존성을 관리 의존성과 비관리 의존성으로 분류
- DB : 관리 의존성, 메시지 버스 : 비관리 의존성
- 관리 의존성은 실제 인스턴스 사용, 메시지 버스는 목 사용

### 8.3.3 엔드 투 엔드 테스트는 어떤가?

- 엔드 투 엔드 테스트는 관리 의존성등을 직접 확인 하지 않고, 애플리케이션을 통해 간접적으로 확인해야한다.

## 8.4 의존성 추상화를 위한 인터페이스 사용

- 프로세스 외부 의존성에 인터페이스를 사용하는 이유?
    - 목을 사용하기 위함
    - 비관리 의존성에 대해서만 인터페이스를 쓸 것

## 8.5 통합 테스트 모범 사례

- 도메인 모델 경계 명시하기 :
- 애플리케이션 내 계층 줄이기 : 가능 한 간접 계층을 적게 사용하라.
- 순환 의존성 제거하기

## 8.6 로깅 기능을 테스트 하는 방법

### 8.6.1. 로깅을 테스트해야 하는가?

- 개발자 이외에 다른 사람이 보는 경우라면 식별할 수 있는 동작이므로 반드시 테스트 필요
- 개발자만 보는 경우 구현 세부사항이므로 테스트 불필요

### 8.6.2 로깅을 어떻게 테스트해야 하는가?

- 로깅에는 프로세스 외부 의존성 존재
- 지원로깅 : 지원 담당자나 시스템 관리자가 추적할 수 있는 메시지 생성
- 진단로깅: 개발자의 내부 상황 파악을 도움

### 8.6.3 로깅이 얼마나 많으면 충분한가?

- 도메인 모델에서는 진단로깅을 사용하지 말 것
- 대부분의 경우 컨트롤러에서 해도 괜찮음

### 8.6.4 로거 인스턴스를 어떻게 전달하는가?

- 정적 메서드 사용 → 적절하지 않음
- 생성자를 통해 주입

## 8.7 결론

- 로그 저장소도 프로세스 외부 의존성
- 지원로깅인 경우 목으로 처리, 진단로깅인 경우 테스트 하지 말것
