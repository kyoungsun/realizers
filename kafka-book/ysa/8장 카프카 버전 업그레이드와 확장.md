# 8장

### 8.1 카프카 버전 업그레이드를 위한 준비

---

- 다운타임 O :  카프카 종료 후 최신 버전으로 실행
- 다운타임 X  : 브로커 한 대 씩 차례로 롤링 업그레이드 방법 사용

### 8.2 주키퍼 의존성이 있는 카프카 롤링 업데이트

---

- 최신 버전의 카프카 다운로드와 설정
    - 버전 업그레이드시 설정 파일 복사를 통해 기존에 있던 설정을 유지
    - server.properties
        - `inter.broker.protocol.version` : 브로커 간의 내부 통신 버전
        - `log.message.format.version` : 메시지 포멧 버전
    - 브로커 설정파일을 기존 버전과 연동되도록 설정하지 않으면, 다른 버전인 브로커들(업그레이드전)과 통신할 수 없음
- 브로커 버전 업그레이드
    - 모든 브로커들을 한대씩 차례대로 업그레이드 (종료 - 업그레이드-재시작)
    - 설정파일을 통해 버전을 기존과 동일하도록 설정 필수 (프로토컬 버전, 메시지 통신버전)
    - 설정 파일 변경
- 브로커 설정 변경
    - `inter.broker.protocol.version, log.message.format.version` 삭제
    - 브로커 한대씩 재시작
- 업그레이드 작업 시 주의 사항
    - 운영환경과 똑같이 개발용 카프카 구성 후 버전 업그레이드 수행 권장
    - 카프카의 사용량이 적은 시간대에 수행 권장

### 8.3 카프카의 확장

---

- 브로커 추가 후 기존의 파티션들을 재할당 필요 (부하 분산) → 수동으로 분산작업 필요
- 브로커 부하 분산
    - 모든 브로커에게 균등하게 파티션 분산
    - 재할당 시킬 토픽들의 json 파일 생성 `reassign-partitions-topic.json`
    - `kafka-reassign-partitions` 명령어를 이용해 파티션을 분산시킬 브로커 리스트를 지정하여 제안된 파티션 배치 출력
    - 제안된 파티션 배치로 json 파일 생성 `move.json`
    - 파티션 재배치 실행
    - 분산 배치 작업 시 주의 사항
        - 카프카의 사용량이 낮은 시간대에 작업
        - 파티션의 크기가 너무 큰 경우 파티션의 크기를 줄일 수 있는지 확인 후 작업 필요
            - 해당 토픽의 임시로 보관주기를 줄여도 문제가 없는지 확인 (과거의 메시지가 필요없는 경우)
        - 한번에 하나의 토픽만 분산 배치