# 카프카 운영과 모니터링

## 안정적인 운영을 위한 주키퍼와 카프카 구성

### 주키퍼

* 주키퍼 서버는 반드시 홀수로 구성, **최소 수량은 3대로 구성**
* 카프카가 중요한 용도로 사용되면 주키퍼는 5대로 구성해 안정성을 높이는 쪽을 추천
* 메모리 크기는 4~8GB로 구성, 디스크는 240G, 480G SSD를 사용
  * JVM 힙 크기는 1GB이므로 이보다 큰 메모리 사용
* 네트워크 카드는 1G 이더넷 카드로 구성
* 물리 서버에 배치하는 경우 여러 랙에 마운트, AWS 환경일 경우 2~3개의 가용 영역에 분산해 구성

### 카프카

* 반드시 홀수로 구성할 필요는 없지만 **안정적인 리플리케이션 팩터 수를 충족하기 위해 최소 3대로 구성**
  * 확장이 쉬우므로 현재 꼭 필요한 수량만큼만 구성
* CPU 사용률이 높은 편으로 코어 수가 많은 CPU 사용
* 메모리는 32GB~256GB까지 다양하게 선택 가능
  * JVM 힙 크기는 6GB이므로 이보다 큰 메모리 사용
  * 힙 크기를 제외한 나머지 물리 메모리는 모두 페이지 캐시로 사용됨
* 토픽의 보관 주기를 충분하게 설정하려면 최소 4TB 용량 이상의 디스크 선택
  * 로그 마지막에 순차적으로 쓰는 방식으로 로그를 기록하기 때문에 저성능의 SATA 디스크를 사용해도 높은 성능을 보장함
  * 병렬로 여러개의 디스크를 장착함
  * NAS의 경우 단일 장애 포인트가 될 수 있으므로 주의가 필요함
  * AWS EBS 스토리지는 용량을 줄일 수 없으므로 초기 설정을 주의해서 설정할 것
* 네트워크 카드는 10G 이더넷 카드로 구성
* 주키퍼와 동일하게 여러 랙에 마운트하거나 여러 가용 영역에 분산하여 배치

### AWS에서 Kafka를 구성하는 방법

* [Amazon Managed Streaming for Apache Kafka(MSK)](https://aws.amazon.com/ko/msk/) 사용
* 직접 Kafka Cluster 구성

# 카프카 버전 업그레이드와 확장

### 주키퍼 의존성이 있는 카프카 롤링 업그레이드

1. 최신 버전 카프카 다운로드 및 설정 파일 복사
   * 아래 2개의 옵션을 이전 버전으로 설정
      * `inter.broker.protocol.version`
      * `log.message.format.version`
2. 브로커를 1대씩 순자적으로 업그레이드 진행
   * 브로커가 실행되면 토픽 상세보기 명령어를 입력하여 리플리케이션과 ISR이 잘 동작하는지 확인
   * 정상 동작 시 남은 브로커들도 순차적으로 업그레이드 진행
3. 모든 브로커 버전이 변경되면 다시 한 대씩 1번에서 설정한 설정 제거

### 카프카의 확장

* 브로커 서버를 추가하더라고 기존의 토픽과 파티션은 관리자가 수작업 토픽의 파티션들을 고르게 분산시켜야함
* 브로커 서버 추가 후 새로 생성되는 신규 토픽은 자동으로 분산 배치됨
* 파티션 분산은 내부적으로 리플리케이션하는 동작이 일어남
  * 기존의 파티션을 이동하고자 하는 브로커에 복사하고 기존에 있던 브로커에서 삭제하는 방식
* 파티션의 크기를 줄이고 난 후 재배치를 하면 더 효율적으로 작업을 진행할 수 있음
* 파티션 재배치 작업 시 하나의 토픽씩 천천히 작업을 진행하는 것이 좋음

# 카프카 보안

### 카프카 보안의 세 가지 요소

#### 암호화

* 카프카 서버와 클라이언트 사이에 흐르는 데이터 패킷을 암호화하여 패킷 가로채기를 방어함
* SSL(Secure Socket Layer)을 사용함

#### 인증

* 안전하다고 확인된 클라이언트들만 카프카 서버에 접근할 수 있도록 허용할 때 사용하는 설정
* SASL(Simple Authentication and Security Layer) 프레임워크를 사용함
    * SASL 통신 방법 더 찾아보기
    * 카프카에서는 아래의 4가지 SASL 메커니즘을 지원함
        * GSSAPI
            * 0.9 버전부터 지원
            * 커버로스 인증 방식으로 가장 많이 사용되는 인증 방식
        * PLAIN
            * 0.10.0 버전부터 지원
            * 아이디와 비밀번호를 텍스트 형태로 사용하는 방법
        * SCRAM-SHA-256, SCRAM-SHA-512
            * 0.10.2 버전부터 지원
            * 인증 정보를 주키퍼에 저장해 사용하는 방식, 토큰 방식도 지원하므로 별도의 커버로스 서버가 구성되어 있지 않은 환경에서 인증을 구성해야 할 때 가장 좋은 방식
        * OAUTHBEARER
            * 2.0 버전부터 지원, 카프카에서 제공하는 기능이 매우 한정적으로 운영 환경에서 사용하기 위해서 별도의 핸들러를 구성해야함
            * 3.1.0 버전부터 OIDC 지원

#### 권한

* 인증받은 클라이언트들의 접근할 수 있는 리소스를 관리하기 위한 설정
* ACL(Access Control List)을 사용해 권한을 관리함
